name: Sync Public Assets to Cloudflare R2

on:
  push:
    branches:
      - custom-minting-system
    paths:
      - 'public/**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    name: Upload changed files to R2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2_ACCESS_KEY_ID}
          secret_access_key = ${R2_SECRET_ACCESS_KEY}
          endpoint = ${R2_ENDPOINT}
          acl = public-read
          no_check_bucket = true
          EOF

      - name: Sync public/ to R2
        run: |
          rclone sync public/ r2:${{ secrets.R2_BUCKET_NAME }}/ \
            --progress \
            --transfers 8 \
            --checkers 16 \
            --fast-list \
            --ignore-times \
            --exclude ".DS_Store" \
            --exclude "*.html" \
            --exclude "CLAUDE.md" \
            --exclude "test-*.html" \
            --log-level INFO

      - name: Report sync status
        run: |
          echo "âœ… Successfully synced public/ directory to R2 bucket: ${{ secrets.R2_BUCKET_NAME }}"
          echo "Files are now available at: ${{ secrets.R2_PUBLIC_URL }}"
