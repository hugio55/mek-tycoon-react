<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Toolbar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: white;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .button-container {
            position: relative;
            display: inline-block;
        }
        
        .toolbar-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            min-width: 120px;
        }
        
        .toolbar-button.favorite {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
        }

        .toolbar-button.favorite:hover {
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }

        /* Button color variations */
        .toolbar-button.color-green {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }

        .toolbar-button.color-blue {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .toolbar-button.color-red {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .toolbar-button.color-yellow {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .toolbar-button.color-cyan {
            background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
        }

        .toolbar-button.color-orange {
            background: linear-gradient(135deg, #fd7e14 0%, #e56202 100%);
        }
        
        .toolbar-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .toolbar-button:active {
            transform: translateY(0);
        }

        .toolbar-button.draggable {
            cursor: move;
        }

        .toolbar-button.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .button-container.drag-over {
            position: relative;
        }

        .button-container.drag-over::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #fab617;
            border-radius: 2px;
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .edit-mode .toolbar-button {
            opacity: 0.7;
        }
        
        .settings-panel {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .toggle-edit {
            padding: 8px 16px;
            background: #fab617;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .toggle-edit:hover {
            background: #ffc947;
        }
        
        .button-editor {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .button-editor::-webkit-scrollbar {
            width: 8px;
        }
        
        .button-editor::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .button-editor::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .edit-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .edit-item input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: white;
            font-size: 14px;
        }
        
        .edit-item input:focus {
            outline: none;
            border-color: #fab617;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .edit-item label {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 3px;
        }
        
        .button-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .remove-button {
            padding: 5px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-button:hover {
            background: #c82333;
        }
        
        .favorite-button {
            padding: 5px 10px;
            background: #ffc107;
            color: black;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .favorite-button:hover {
            background: #ffb300;
        }
        
        .favorite-button.is-favorite {
            background: #28a745;
            color: white;
        }
        
        .favorite-button.is-favorite:hover {
            background: #218838;
        }
        
        .add-button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
        }
        
        .add-button:hover {
            background: #218838;
        }
        
        .hidden {
            display: none !important;
        }
        
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .status.show {
            opacity: 1;
        }
        
        h2 {
            color: #fab617;
            margin-bottom: 10px;
        }
        
        .context-menu {
            position: fixed;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
        }
        
        .context-menu.show {
            display: block;
        }
        
        .context-menu-item {
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-menu-item:hover {
            background: rgba(250, 182, 23, 0.2);
        }
        
        .context-menu-item.separator {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 4px 0;
            padding: 0;
            cursor: default;
        }
        
        .context-menu-item:hover.separator {
            background: none;
        }
        
        .context-menu-icon {
            width: 16px;
            text-align: center;
        }

        .context-menu-item.has-submenu::after {
            content: 'â–¶';
            position: absolute;
            right: 10px;
            opacity: 0.5;
        }

        .submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
            margin-left: 5px;
        }

        .context-menu-item:hover .submenu {
            display: block;
        }

        .color-option {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .color-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="toolbar" id="toolbar"></div>
    
    <div class="settings-panel">
        <div class="settings-header">
            <h2>Button Configuration</h2>
            <button class="toggle-edit" onclick="toggleEditMode()">Edit Mode: OFF</button>
        </div>
        
        <div class="button-editor hidden" id="editor"></div>
        <button class="add-button hidden" onclick="addNewButton()">+ Add New Button</button>
    </div>
    
    <div class="instructions">
        <h3>How to use:</h3>
        <ul>
            <li>Click "Edit Mode" to configure your buttons</li>
            <li>Add button names and URLs (e.g., http://localhost:3100)</li>
            <li><strong>Left-click</strong> any button to open/replace the current Chrome tab</li>
            <li><strong>Right-click</strong> any button for more options:
                <ul style="margin-top: 5px; margin-left: 20px; font-size: 13px;">
                    <li>Open in main tab (same as left-click)</li>
                    <li>Open in new tab</li>
                    <li>Open as floating button (small draggable window)</li>
                </ul>
            </li>
            <li>Your configuration is automatically saved</li>
            <li>To run as a desktop app: Save this file and double-click to open in Chrome</li>
        </ul>
    </div>
    
    <div class="status" id="status"></div>
    
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="openInMainTab()">
            <span class="context-menu-icon">ðŸ”—</span>
            Open in Main Tab
        </div>
        <div class="context-menu-item" onclick="openInNewTab()">
            <span class="context-menu-icon">ðŸ†•</span>
            Open in New Tab
        </div>
        <div class="context-menu-item separator"></div>
        <div class="context-menu-item" onclick="toggleContextFavorite()">
            <span class="context-menu-icon" id="favoriteIcon">â˜†</span>
            <span id="favoriteText">Set as Favorite</span>
        </div>
        <div class="context-menu-item has-submenu">
            <span class="context-menu-icon">ðŸŽ¨</span>
            Set Color
            <div class="submenu">
                <div class="color-option" onclick="setButtonColor('default')">
                    <div class="color-swatch" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"></div>
                    Default (Purple)
                </div>
                <div class="color-option" onclick="setButtonColor('green')">
                    <div class="color-swatch" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%)"></div>
                    Green
                </div>
                <div class="color-option" onclick="setButtonColor('blue')">
                    <div class="color-swatch" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%)"></div>
                    Blue
                </div>
                <div class="color-option" onclick="setButtonColor('red')">
                    <div class="color-swatch" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%)"></div>
                    Red
                </div>
                <div class="color-option" onclick="setButtonColor('yellow')">
                    <div class="color-swatch" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%)"></div>
                    Yellow
                </div>
                <div class="color-option" onclick="setButtonColor('cyan')">
                    <div class="color-swatch" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%)"></div>
                    Cyan
                </div>
                <div class="color-option" onclick="setButtonColor('orange')">
                    <div class="color-swatch" style="background: linear-gradient(135deg, #fd7e14 0%, #e56202 100%)"></div>
                    Orange
                </div>
            </div>
        </div>
        <div class="context-menu-item separator"></div>
        <div class="context-menu-item" onclick="copyUrl()">
            <span class="context-menu-icon">ðŸ“‹</span>
            Copy URL
        </div>
        <div class="context-menu-item separator"></div>
        <div class="context-menu-item" onclick="openAsFloatingButton()">
            <span class="context-menu-icon">ðŸŽ¯</span>
            Open as Floating Button
        </div>
    </div>

    <script>
        // Version number - increment this to force refresh of buttons
        const TOOLBAR_VERSION = 7; // Force refresh to remove deleted pages

        // Default buttons configuration - All pages from navigation
        let buttons = [
            // === MAIN PAGES ===
            { name: "Home", url: "http://localhost:3100/", favorite: false, color: 'default' },
            { name: "Hub", url: "http://localhost:3100/hub", favorite: false, color: 'default' },
            { name: "Hub2", url: "http://localhost:3100/hub2", favorite: false, color: 'default' },

            // === OPERATIONS ===
            { name: "Essence Donut", url: "http://localhost:3100/essence-donut", favorite: false, color: 'default' },

            // === PRODUCTION ===
            { name: "Crafting", url: "http://localhost:3100/crafting", favorite: false, color: 'default' },
            { name: "Incinerator", url: "http://localhost:3100/incinerator", favorite: false, color: 'default' },
            { name: "Shop", url: "http://localhost:3100/shop", favorite: false, color: 'default' },
            { name: "Shop WOW", url: "http://localhost:3100/shop-wow", favorite: false, color: 'default' },
            { name: "Bank", url: "http://localhost:3100/bank", favorite: false, color: 'default' },
            { name: "Inventory", url: "http://localhost:3100/inventory", favorite: false, color: 'default' },

            // === MEKS & TALENTS ===
            { name: "CiruTree", url: "http://localhost:3100/cirutree", favorite: false, color: 'default' },
            { name: "Achievements", url: "http://localhost:3100/achievements", favorite: false, color: 'default' },
            { name: "XP Allocation", url: "http://localhost:3100/xp-allocation", favorite: false, color: 'default' },
            { name: "Talent Builder", url: "http://localhost:3100/talent-builder", favorite: false, color: 'default' },

            // === MANAGEMENT ===
            { name: "Profile", url: "http://localhost:3100/profile", favorite: false, color: 'default' },
            { name: "Search", url: "http://localhost:3100/search", favorite: false, color: 'default' },
            { name: "Leaderboard", url: "http://localhost:3100/leaderboard", favorite: false, color: 'default' },
            { name: "Mek Selector", url: "http://localhost:3100/mek-selector", favorite: false, color: 'default' },

            // === CONTRACTS & MISSIONS ===
            { name: "Contracts", url: "http://localhost:3100/contracts", favorite: false, color: 'default' },
            { name: "Contracts Active", url: "http://localhost:3100/contracts/active", favorite: false, color: 'default' },
            { name: "Single Missions", url: "http://localhost:3100/contracts/single-missions", favorite: false, color: 'default' },
            { name: "Story Chapters", url: "http://localhost:3100/contracts/chapters", favorite: false, color: 'default' },
            { name: "Contracts Button Demo", url: "http://localhost:3100/contracts/button-demo", favorite: false, color: 'default' },

            // === SCRAP YARD & GAMES ===
            { name: "Scrapyard", url: "http://localhost:3100/scrapyard", favorite: false, color: 'default' },
            { name: "Story Climb", url: "http://localhost:3100/scrap-yard/story-climb", favorite: false, color: 'default' },
            { name: "Block Game", url: "http://localhost:3100/scrap-yard/block-game", favorite: false, color: 'default' },

            // === CHIPS & SPECIAL ===
            { name: "Mek Chips 3", url: "http://localhost:3100/mek-chips-3", favorite: false, color: 'default' },
            { name: "Chip Builder", url: "http://localhost:3100/admin/chip-builder", favorite: false, color: 'default' },
            { name: "Sphere Selector", url: "http://localhost:3100/sphere-selector", favorite: false, color: 'default' },

            // === ADMIN TOOLS ===
            { name: "Admin Dashboard", url: "http://localhost:3100/admin", favorite: false, color: 'default' },
            { name: "Admin Save System", url: "http://localhost:3100/admin-save", favorite: false, color: 'default' },
            { name: "Admin Shop Manager", url: "http://localhost:3100/admin-shop", favorite: false, color: 'default' },
            { name: "Admin Sphere", url: "http://localhost:3100/admin-sphere", favorite: false, color: 'default' },
            { name: "Admin Master Data", url: "http://localhost:3100/admin-master-data", favorite: false, color: 'default' },
            { name: "Admin Mek Tree Tables", url: "http://localhost:3100/admin-mek-tree-tables", favorite: false, color: 'default' },
            { name: "Admin Users", url: "http://localhost:3100/admin/users", favorite: false, color: 'default' },
            { name: "Admin Buff Categories", url: "http://localhost:3100/admin/buff-categories", favorite: false, color: 'default' },
            { name: "Admin Buff Seed", url: "http://localhost:3100/admin/buff-categories/seed", favorite: false, color: 'default' },
            { name: "Admin Frames", url: "http://localhost:3100/admin/frames", favorite: false, color: 'default' },

            // === UI & TESTING ===
            { name: "UI Showcase", url: "http://localhost:3100/ui-showcase", favorite: false, color: 'default' },
            { name: "Rarity Bias", url: "http://localhost:3100/rarity-bias", favorite: false, color: 'default' }
        ];
        
        let editMode = false;
        let chromeTab = null;
        let currentContextButton = null;
        let draggedButton = null;
        let draggedIndex = null;
        
        // Load saved configuration
        function loadConfig() {
            try {
                // ALWAYS try to preserve favorites and colors from saved config
                const saved = localStorage.getItem('devToolbarButtons');
                const savedSettings = {};

                if (saved) {
                    try {
                        const savedButtons = JSON.parse(saved);
                        // Create a map of saved button settings indexed by URL
                        savedButtons.forEach(btn => {
                            savedSettings[btn.url] = {
                                favorite: btn.favorite || false,
                                color: btn.color || 'default',
                                customOrder: savedButtons.indexOf(btn) // Preserve custom order
                            };
                        });
                        console.log('Loaded settings for', Object.keys(savedSettings).length, 'buttons');
                    } catch (e) {
                        console.error('Failed to parse saved settings:', e);
                    }
                }

                // Check version to see if we need to update button list
                const savedVersion = localStorage.getItem('devToolbarVersion');
                if (savedVersion !== String(TOOLBAR_VERSION)) {
                    console.log('Toolbar version changed from', savedVersion, 'to', TOOLBAR_VERSION);

                    // PRESERVE USER'S CUSTOM ORDER
                    const orderedButtons = [];

                    if (saved) {
                        try {
                            const savedButtons = JSON.parse(saved);

                            // First, add all saved buttons that still exist in the default list (preserving order)
                            savedButtons.forEach(savedBtn => {
                                const defaultBtn = buttons.find(btn => btn.url === savedBtn.url);
                                if (defaultBtn) {
                                    // Button still exists in defaults, preserve its settings and position
                                    orderedButtons.push({
                                        ...defaultBtn,
                                        favorite: savedBtn.favorite || false,
                                        color: savedBtn.color || 'default'
                                    });
                                } else if (savedBtn.name && savedBtn.url) {
                                    // Custom button not in defaults, preserve it
                                    orderedButtons.push(savedBtn);
                                }
                            });

                            // Then add any new buttons from defaults that weren't in saved (at the end)
                            buttons.forEach(defaultBtn => {
                                const alreadyAdded = orderedButtons.some(btn => btn.url === defaultBtn.url);
                                if (!alreadyAdded) {
                                    orderedButtons.push(defaultBtn);
                                    console.log('Added new button:', defaultBtn.name);
                                }
                            });

                            // Replace buttons with the ordered list
                            buttons = orderedButtons;
                            console.log('Preserved custom order with', buttons.length, 'buttons');

                        } catch (e) {
                            console.error('Failed to preserve order:', e);
                            // Fall back to just preserving settings without order
                            buttons.forEach(btn => {
                                if (savedSettings[btn.url]) {
                                    btn.favorite = savedSettings[btn.url].favorite;
                                    btn.color = savedSettings[btn.url].color;
                                }
                            });
                        }
                    } else {
                        // No saved config, just apply settings
                        buttons.forEach(btn => {
                            if (savedSettings[btn.url]) {
                                btn.favorite = savedSettings[btn.url].favorite;
                                btn.color = savedSettings[btn.url].color;
                            }
                        });
                    }

                    localStorage.setItem('devToolbarVersion', String(TOOLBAR_VERSION));
                    saveConfig(); // Save the merged config
                    return;
                }

                // Version matches, so load the full saved config including custom order
                const savedConfig = localStorage.getItem('devToolbarButtons');
                if (savedConfig) {
                    try {
                        const savedButtons = JSON.parse(savedConfig);
                        // Validate saved buttons
                        if (Array.isArray(savedButtons) && savedButtons.length > 0) {
                            // Use the saved button order and settings
                            buttons = savedButtons;
                            console.log('Loaded', buttons.length, 'buttons from storage (including custom order)');
                        } else {
                            console.log('Invalid saved config format, using defaults');
                        }
                    } catch (e) {
                        console.error('Failed to parse saved config:', e);
                    }
                } else {
                    // No saved config yet, apply any previously saved settings to defaults
                    buttons.forEach(btn => {
                        if (savedSettings[btn.url]) {
                            btn.favorite = savedSettings[btn.url].favorite;
                            btn.color = savedSettings[btn.url].color;
                        }
                    });
                    console.log('No saved config, using defaults with preserved settings');
                }
            } catch (e) {
                console.error('Failed to access localStorage:', e);
            }
        }
        
        // Save configuration
        function saveConfig() {
            localStorage.setItem('devToolbarButtons', JSON.stringify(buttons));
            showStatus('Configuration saved!');
        }
        
        // Show status message
        function showStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.classList.add('show');
            setTimeout(() => {
                status.classList.remove('show');
            }, 2000);
        }
        
        // Sort buttons with favorites first
        function getSortedButtons() {
            return [...buttons].sort((a, b) => {
                if (a.favorite && !b.favorite) return -1;
                if (!a.favorite && b.favorite) return 1;
                return 0;
            });
        }
        
        // Render toolbar buttons
        function renderToolbar() {
            const toolbar = document.getElementById('toolbar');
            if (!toolbar) {
                console.error('Toolbar element not found!');
                return;
            }
            toolbar.innerHTML = '';

            const sortedButtons = getSortedButtons();
            console.log('Rendering', sortedButtons.length, 'buttons');

            sortedButtons.forEach((button, index) => {
                const originalIndex = buttons.indexOf(button);
                const container = document.createElement('div');
                container.className = 'button-container';
                container.dataset.index = index;

                const btn = document.createElement('button');
                // Apply color class if set
                let classes = ['toolbar-button'];
                if (!editMode) classes.push('draggable');
                if (button.favorite) classes.push('favorite');
                if (button.color && button.color !== 'default') {
                    classes.push(`color-${button.color}`);
                }
                btn.className = classes.join(' ');

                btn.textContent = button.name;
                btn.dataset.url = button.url;
                btn.dataset.index = originalIndex;

                // Make draggable when not in edit mode
                if (!editMode) {
                    btn.draggable = true;

                    btn.onclick = () => openInChrome(button.url, button.name);
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        showContextMenu(e, button);
                        return false;
                    };

                    // Drag events on button
                    btn.ondragstart = (e) => handleDragStart(e, index, button);
                    btn.ondragend = handleDragEnd;

                    // Drop events on container
                    container.ondragover = handleDragOver;
                    container.ondrop = (e) => handleDrop(e, index);
                    container.ondragleave = handleDragLeave;
                }

                container.appendChild(btn);
                toolbar.appendChild(container);
            });
        }
        
        // Open URL in Chrome (same tab)
        function openInChrome(url, name) {
            if (!url) {
                showStatus('No URL configured for this button');
                return;
            }
            
            // If we don't have a reference to the Chrome tab, or it's closed, open a new one
            if (!chromeTab || chromeTab.closed) {
                chromeTab = window.open(url, 'mainDevToolbarTarget');
                showStatus(`Opened: ${name}`);
            } else {
                // Replace the URL in the existing tab
                chromeTab.location.href = url;
                chromeTab.focus();
                showStatus(`Navigated to: ${name}`);
            }
        }
        
        // Toggle edit mode
        function toggleEditMode() {
            editMode = !editMode;
            const editor = document.getElementById('editor');
            const addBtn = document.querySelector('.add-button');
            const toggleBtn = document.querySelector('.toggle-edit');
            
            toggleBtn.textContent = editMode ? 'Edit Mode: ON' : 'Edit Mode: OFF';
            toggleBtn.style.background = editMode ? '#28a745' : '#fab617';
            
            if (editMode) {
                editor.classList.remove('hidden');
                addBtn.classList.remove('hidden');
                document.querySelector('.toolbar').classList.add('edit-mode');
                renderEditor();
            } else {
                editor.classList.add('hidden');
                addBtn.classList.add('hidden');
                document.querySelector('.toolbar').classList.remove('edit-mode');
                saveConfig();
            }
            
            renderToolbar();
        }
        
        // Render button editor
        function renderEditor() {
            const editor = document.getElementById('editor');
            editor.innerHTML = '';
            
            const sortedButtons = getSortedButtons();
            
            sortedButtons.forEach((button) => {
                const index = buttons.indexOf(button);
                const item = document.createElement('div');
                item.className = 'edit-item';
                
                item.innerHTML = `
                    <label>Button Name:</label>
                    <input type="text" value="${button.name}" onchange="updateButton(${index}, 'name', this.value)">
                    <label>URL:</label>
                    <input type="text" value="${button.url}" onchange="updateButton(${index}, 'url', this.value)">
                    <div class="button-actions">
                        <button class="favorite-button ${button.favorite ? 'is-favorite' : ''}" onclick="toggleFavorite(${index})">
                            ${button.favorite ? 'â˜… Favorited' : 'â˜† Favorite'}
                        </button>
                        <button class="remove-button" onclick="removeButton(${index})">Remove</button>
                    </div>
                `;
                
                editor.appendChild(item);
            });
        }
        
        // Update button configuration
        function updateButton(index, field, value) {
            buttons[index][field] = value;
            renderToolbar();
        }
        
        // Remove button
        function removeButton(index) {
            if (confirm('Remove this button?')) {
                buttons.splice(index, 1);
                renderEditor();
                renderToolbar();
            }
        }
        
        // Toggle favorite status
        function toggleFavorite(index) {
            buttons[index].favorite = !buttons[index].favorite;
            renderEditor();
            renderToolbar();
            saveConfig();
        }
        
        // Add new button
        function addNewButton() {
            buttons.push({
                name: `Button ${buttons.length + 1}`,
                url: 'http://localhost:3100/',
                favorite: false,
                color: 'default'
            });
            renderEditor();
            renderToolbar();
        }
        
        // Show context menu
        function showContextMenu(event, button) {
            currentContextButton = button;
            const menu = document.getElementById('contextMenu');

            // Update favorite icon and text
            const favoriteIcon = document.getElementById('favoriteIcon');
            const favoriteText = document.getElementById('favoriteText');
            if (button.favorite) {
                favoriteIcon.textContent = 'â˜…';
                favoriteText.textContent = 'Remove from Favorites';
            } else {
                favoriteIcon.textContent = 'â˜†';
                favoriteText.textContent = 'Set as Favorite';
            }

            // Position the menu at cursor
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';

            // Make sure menu doesn't go off screen
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                }
            }, 0);

            menu.classList.add('show');
        }
        
        // Hide context menu
        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('show');
        }
        
        // Context menu actions
        function openInMainTab() {
            if (currentContextButton) {
                openInChrome(currentContextButton.url, currentContextButton.name);
            }
            hideContextMenu();
        }
        
        function openInNewTab() {
            if (currentContextButton) {
                window.open(currentContextButton.url, '_blank');
                showStatus(`Opened in new tab: ${currentContextButton.name}`);
            }
            hideContextMenu();
        }
        
        function openAsFloatingButton() {
            if (currentContextButton) {
                createFloatingButton(currentContextButton);
            }
            hideContextMenu();
        }

        function copyUrl() {
            if (currentContextButton) {
                // Copy to clipboard
                navigator.clipboard.writeText(currentContextButton.url).then(() => {
                    showStatus(`Copied URL: ${currentContextButton.url}`);
                }).catch(err => {
                    // Fallback method for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = currentContextButton.url;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showStatus(`Copied URL: ${currentContextButton.url}`);
                    } catch (err) {
                        showStatus('Failed to copy URL');
                    }
                    document.body.removeChild(textArea);
                });
            }
            hideContextMenu();
        }

        function toggleContextFavorite() {
            if (currentContextButton) {
                const index = buttons.indexOf(currentContextButton);
                if (index !== -1) {
                    buttons[index].favorite = !buttons[index].favorite;
                    renderToolbar();
                    saveConfig();
                    showStatus(buttons[index].favorite ? 'Added to favorites' : 'Removed from favorites');
                }
            }
            hideContextMenu();
        }

        function setButtonColor(color) {
            if (currentContextButton) {
                const index = buttons.indexOf(currentContextButton);
                if (index !== -1) {
                    buttons[index].color = color;
                    renderToolbar();
                    saveConfig();
                    showStatus(`Color changed to ${color}`);
                }
            }
            hideContextMenu();
        }
        
        // Create floating button window
        function createFloatingButton(button) {
            const floatingHTML = '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                    '<title>' + button.name + '</title>' +
                    '<style>' +
                        '* {' +
                            'margin: 0;' +
                            'padding: 0;' +
                            'box-sizing: border-box;' +
                        '}' +
                        'body {' +
                            'background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);' +
                            'display: flex;' +
                            'justify-content: center;' +
                            'align-items: center;' +
                            'height: 100vh;' +
                            'overflow: hidden;' +
                            '-webkit-app-region: drag;' +
                        '}' +
                        '.floating-button {' +
                            'padding: 20px 30px;' +
                            'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' +
                            'border: none;' +
                            'border-radius: 12px;' +
                            'color: white;' +
                            'font-size: 16px;' +
                            'font-weight: 700;' +
                            'cursor: pointer;' +
                            'box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);' +
                            'transition: all 0.3s ease;' +
                            'text-align: center;' +
                            '-webkit-app-region: no-drag;' +
                            'font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;' +
                            'min-width: 100px;' +
                        '}' +
                        '.floating-button:hover {' +
                            'transform: scale(1.05);' +
                            'box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);' +
                        '}' +
                        '.floating-button:active {' +
                            'transform: scale(0.98);' +
                        '}' +
                        '.floating-button.favorite {' +
                            'background: linear-gradient(135deg, #28a745 0%, #218838 100%);' +
                        '}' +
                        '.close-hint {' +
                            'position: absolute;' +
                            'top: 5px;' +
                            'right: 5px;' +
                            'color: rgba(255, 255, 255, 0.5);' +
                            'font-size: 10px;' +
                            'font-family: "Segoe UI", sans-serif;' +
                            '-webkit-app-region: no-drag;' +
                        '}' +
                    '</style>' +
                '</head>' +
                '<body>' +
                    '<div class="close-hint">Alt+F4 to close</div>' +
                    '<button class="floating-button ' + (button.favorite ? 'favorite' : '') + '" onclick="navigateTo(\'' + button.url.replace(/'/g, "\\'") + '\')">' +
                        button.name +
                    '</button>' +
                    '<script>' +
                        'let targetTab = null;' +
                        'function navigateTo(url) {' +
                            'if (!targetTab || targetTab.closed) {' +
                                'targetTab = window.open(url, "mainDevToolbarTarget");' +
                            '} else {' +
                                'targetTab.location.href = url;' +
                                'targetTab.focus();' +
                            '}' +
                        '}' +
                        'document.addEventListener("DOMContentLoaded", () => {' +
                            '// Window is draggable via CSS -webkit-app-region' +
                        '});' +
                    '</' + 'script>' +
                '</body>' +
                '</html>';
            
            // Create a blob URL for the HTML
            const blob = new Blob([floatingHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            // Open as a small floating window
            const width = Math.max(150, button.name.length * 10 + 60);
            const height = 100;
            const left = window.screen.width - width - 50;
            const top = 50;
            
            // Use popup type for cleaner window (though Chrome may still show some UI)
            const features = `popup=yes,width=${width},height=${height},left=${left},top=${top}`;
            
            const floatingWindow = window.open(url, `floating_${button.name.replace(/\s+/g, '_')}`, features);
            
            if (floatingWindow) {
                showStatus(`Created floating button: ${button.name}`);
                
                // Clean up blob URL after window loads
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
            }
        }
        
        // Drag and drop handlers
        function handleDragStart(e, index, button) {
            draggedButton = button;
            draggedIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedButton = null;
            draggedIndex = null;

            // Remove all drag-over classes
            document.querySelectorAll('.button-container').forEach(container => {
                container.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const container = e.target.closest('.button-container');
            if (container && !container.querySelector('.dragging')) {
                // Remove drag-over from all containers
                document.querySelectorAll('.button-container').forEach(c => {
                    c.classList.remove('drag-over');
                });
                // Add to current container
                container.classList.add('drag-over');
            }

            return false;
        }

        function handleDragLeave(e) {
            const container = e.target.closest('.button-container');
            if (container) {
                container.classList.remove('drag-over');
            }
        }

        function handleDrop(e, dropIndex) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();

            const container = e.target.closest('.button-container');
            if (container) {
                container.classList.remove('drag-over');
            }

            if (draggedButton && draggedIndex !== null && draggedIndex !== dropIndex) {
                // Get the sorted buttons array
                const sortedButtons = getSortedButtons();

                // Remove dragged button from its original position
                const [removed] = sortedButtons.splice(draggedIndex, 1);

                // Insert at new position
                sortedButtons.splice(dropIndex, 0, removed);

                // Now we need to update the main buttons array to match this new order
                // We'll create a new array with the sorted order
                const newButtons = [];

                // First add all favorites in their new order
                sortedButtons.forEach(btn => {
                    if (btn.favorite) {
                        newButtons.push(btn);
                    }
                });

                // Then add all non-favorites in their new order
                sortedButtons.forEach(btn => {
                    if (!btn.favorite) {
                        newButtons.push(btn);
                    }
                });

                // Replace the buttons array
                buttons = newButtons;

                // Save and re-render
                saveConfig();
                renderToolbar();
                showStatus('Button order updated');
            }

            return false;
        }

        // Click outside to close context menu
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) {
                hideContextMenu();
            }
        });
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM loaded, initializing toolbar...');
                loadConfig();
                renderToolbar();
            });
        } else {
            // DOM is already loaded
            console.log('Initializing toolbar...');
            loadConfig();
            renderToolbar();
        }
        
        // Save config when page unloads
        window.addEventListener('beforeunload', () => {
            saveConfig(); // Always save config when closing, not just in edit mode
        });
        
        // Add error handler
        window.addEventListener('error', (e) => {
            console.error('JavaScript error:', e);
        });
    </script>
</body>
</html>