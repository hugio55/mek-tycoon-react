'use client';

import { useEffect, useRef, useState } from 'react';
import Image from 'next/image';
import PhaseCarousel from '@/components/PhaseCarousel';

interface Star {
  x: number;
  y: number;
  z: number;
  size: number;
}

interface BackgroundStar {
  x: number;
  y: number;
  brightness: number;
  twinkleOffset: number;
}

interface AsteroidStar {
  x: number;
  y: number;
  depth: number; // 0-1, closer = 1
  size: number;
}

export default function LandingPage() {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  // Control states
  const [starScale, setStarScale] = useState(1);
  const [starSpeed, setStarSpeed] = useState(3);
  const [starFrequency, setStarFrequency] = useState(200);
  const [logoSize, setLogoSize] = useState(600);
  const [selectedFont, setSelectedFont] = useState('Orbitron');
  const [animationMode, setAnimationMode] = useState<'forward' | 'glide'>('forward');
  const [fontDropdownOpen, setFontDropdownOpen] = useState(false);

  // Motion blur controls
  const [motionBlurEnabled, setMotionBlurEnabled] = useState(true);
  const [motionBlurIntensity, setMotionBlurIntensity] = useState(0.5);

  // Available fonts for testing
  const fonts = [
    'Orbitron',
    'Rajdhani',
    'Exo 2',
    'Electrolize',
    'Audiowide',
    'Michroma',
    'Saira',
    'Play',
    'Quantico',
    'Arial',
    'Helvetica',
    'Courier New',
    'Georgia',
    'Times New Roman'
  ];

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const updateCanvasSize = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };
    updateCanvasSize();
    window.addEventListener('resize', updateCanvasSize);

    // Create distant background star field (static/very slow)
    const backgroundStars: BackgroundStar[] = [];
    const numBackgroundStars = 800;
    for (let i = 0; i < numBackgroundStars; i++) {
      backgroundStars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        brightness: Math.random() * 0.3 + 0.1, // Very dim
        twinkleOffset: Math.random() * Math.PI * 2,
      });
    }

    const stars: Star[] = [];
    const maxZ = 1500;
    const coneAngle = 25; // Degrees - creates exclusion cone in center

    // Initialize stars outside the cone of impenetrability
    const initializeStar = () => {
      let x, y;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      // Keep trying until we get a star outside the center cone
      do {
        x = Math.random() * canvas.width - canvas.width / 2;
        y = Math.random() * canvas.height - canvas.height / 2;

        // Calculate angle from center
        const distance = Math.sqrt(x * x + y * y);
        const angleFromCenter = Math.atan2(Math.abs(y), Math.abs(x)) * (180 / Math.PI);

        // Check if outside cone (cone points toward viewer)
        const maxAllowedDistance = Math.tan((coneAngle * Math.PI) / 180) * maxZ;
        if (distance > maxAllowedDistance * 0.3) break; // 0.3 makes cone stricter at spawn
      } while (true);

      return { x, y };
    };

    for (let i = 0; i < starFrequency; i++) {
      const { x, y } = initializeStar();
      stars.push({
        x,
        y,
        z: Math.random() * maxZ,
        size: Math.random() * 2 + 1,
      });
    }

    // Create asteroid belt stars for glide mode
    const asteroidStars: AsteroidStar[] = [];
    for (let i = 0; i < starFrequency; i++) {
      asteroidStars.push({
        x: Math.random() * canvas.width,
        y: canvas.height * 0.4 + Math.random() * canvas.height * 0.6, // Lower half of screen
        depth: Math.random(), // 0 = distant, 1 = close
        size: Math.random() * 3 + 0.5,
      });
    }

    let animationId: number;
    const animate = () => {
      // Clear with black
      ctx.fillStyle = 'rgba(0, 0, 0, 1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (animationMode === 'forward') {
        // FORWARD MOTION MODE (Current implementation)
        // Draw distant background stars (very slow drift)
        const time = Date.now() * 0.00005; // Very slow movement
        backgroundStars.forEach((star) => {
          const twinkle = Math.sin(time + star.twinkleOffset) * 0.1 + 0.9;
          const opacity = star.brightness * twinkle;

          ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
          ctx.beginPath();
          ctx.arc(star.x, star.y, 0.5, 0, Math.PI * 2);
          ctx.fill();
        });

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        // Draw moving stars
        stars.forEach((star) => {
          star.z -= starSpeed;

          if (star.z <= 0) {
            const { x, y } = initializeStar();
            star.x = x;
            star.y = y;
            star.z = maxZ;
          }

          const scale = 1000 / star.z;
          const x = star.x * scale + centerX;
          const y = star.y * scale + centerY;
          const size = (star.size * scale) * starScale;

          if (x >= 0 && x <= canvas.width && y >= 0 && y <= canvas.height) {
            const opacity = Math.min(1, (maxZ - star.z) / maxZ);
            ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fill();

            // Draw star trails for closer stars with motion blur
            if (motionBlurEnabled && star.z < 500) {
              // Calculate velocity-based blur
              const velocity = starSpeed;
              const blurLength = velocity * motionBlurIntensity * 2;

              // Trail opacity based on blur intensity
              const trailOpacity = opacity * 0.5 * motionBlurIntensity;

              ctx.strokeStyle = `rgba(255, 255, 255, ${trailOpacity})`;
              ctx.lineWidth = size / 2;

              // Add blur filter for motion blur effect
              if (velocity > 2) {
                ctx.filter = `blur(${Math.min(velocity * motionBlurIntensity * 0.3, 3)}px)`;
              }

              ctx.beginPath();
              const prevZ = star.z + starSpeed * blurLength;
              const prevScale = 1000 / prevZ;
              const prevX = star.x * prevScale + centerX;
              const prevY = star.y * prevScale + centerY;
              ctx.moveTo(prevX, prevY);
              ctx.lineTo(x, y);
              ctx.stroke();

              // Reset filter
              ctx.filter = 'none';
            }
          }
        });
      } else {
        // ASTEROID BELT GLIDE MODE
        // Draw distant background stars (static)
        backgroundStars.forEach((star) => {
          ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness * 0.5})`;
          ctx.beginPath();
          ctx.arc(star.x, star.y * 0.3, 0.5, 0, Math.PI * 2); // Push stars toward horizon
          ctx.fill();
        });

        // Draw horizon line (subtle)
        const horizonY = canvas.height * 0.35;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, horizonY);
        ctx.lineTo(canvas.width, horizonY);
        ctx.stroke();

        // Animate asteroid belt stars with parallax
        asteroidStars.forEach((star) => {
          // Parallax speed based on depth (closer = faster)
          const parallaxSpeed = starSpeed * (0.3 + star.depth * 1.5);
          star.x -= parallaxSpeed;

          // Wrap around when off screen
          if (star.x < -50) {
            star.x = canvas.width + 50;
            star.y = canvas.height * 0.4 + Math.random() * canvas.height * 0.6;
            star.depth = Math.random();
          }

          // Size and opacity based on depth
          const size = (star.size * (0.5 + star.depth * 1.5)) * starScale;
          const opacity = 0.3 + star.depth * 0.7;

          // Draw star
          ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
          ctx.beginPath();
          ctx.arc(star.x, star.y, size, 0, Math.PI * 2);
          ctx.fill();

          // Draw subtle trail for closer stars with motion blur
          if (motionBlurEnabled && star.depth > 0.7) {
            const trailLength = parallaxSpeed * motionBlurIntensity * 3;
            const trailOpacity = opacity * 0.3 * motionBlurIntensity;

            ctx.strokeStyle = `rgba(255, 255, 255, ${trailOpacity})`;
            ctx.lineWidth = size * 0.5;

            // Add blur filter for fast-moving stars
            if (parallaxSpeed > 3) {
              ctx.filter = `blur(${Math.min(parallaxSpeed * motionBlurIntensity * 0.2, 2)}px)`;
            }

            ctx.beginPath();
            ctx.moveTo(star.x + trailLength, star.y);
            ctx.lineTo(star.x, star.y);
            ctx.stroke();

            // Reset filter
            ctx.filter = 'none';
          }
        });
      }

      animationId = requestAnimationFrame(animate);
    };

    animate();

    return () => {
      window.removeEventListener('resize', updateCanvasSize);
      cancelAnimationFrame(animationId);
    };
  }, [starScale, starSpeed, starFrequency, animationMode, motionBlurEnabled, motionBlurIntensity]);

  return (
    <div className="relative w-full h-screen bg-black overflow-hidden">
      <canvas
        ref={canvasRef}
        className="fixed inset-0 w-full h-full z-0"
        style={{ display: 'block' }}
      />

      {/* Distant Enormous Planet - Only partial edge visible */}
      <div
        className="fixed z-[1] pointer-events-none"
        style={{
          width: '3000px',
          height: '3000px',
          right: '-2200px',
          bottom: '-2200px',
          borderRadius: '50%',
          background: `
            radial-gradient(
              circle at 35% 35%,
              rgba(100, 60, 40, 0.4) 0%,
              rgba(80, 50, 30, 0.35) 20%,
              rgba(60, 40, 25, 0.3) 40%,
              rgba(40, 30, 20, 0.25) 60%,
              rgba(20, 15, 10, 0.15) 80%,
              rgba(0, 0, 0, 0) 100%
            )
          `,
          boxShadow: `
            inset -50px -50px 150px rgba(0, 0, 0, 0.8),
            inset 30px 30px 100px rgba(100, 60, 40, 0.1),
            0 0 200px rgba(100, 60, 40, 0.1)
          `,
          filter: 'blur(2px)',
          opacity: 0.6,
        }}
      >
        {/* Subtle atmospheric glow around planet edge */}
        <div
          className="absolute inset-0 rounded-full"
          style={{
            background: `
              radial-gradient(
                circle at 35% 35%,
                transparent 0%,
                transparent 85%,
                rgba(150, 100, 60, 0.1) 90%,
                rgba(200, 140, 80, 0.05) 95%,
                transparent 100%
              )
            `,
          }}
        />
      </div>

      {/* Font Tester - Compact dropdown in top-left */}
      <div className="fixed left-4 top-4 z-[100]">
        <select
          value={selectedFont}
          onChange={(e) => setSelectedFont(e.target.value)}
          className="bg-black/90 backdrop-blur-sm border-2 border-yellow-500/50 rounded px-3 py-2 text-yellow-400 text-xs font-orbitron uppercase tracking-wider cursor-pointer hover:border-yellow-400/70 transition-all focus:outline-none focus:border-yellow-400 max-w-[150px]"
          style={{ fontFamily: selectedFont }}
        >
          {fonts.map((font) => (
            <option key={font} value={font} style={{ fontFamily: font }}>
              {font}
            </option>
          ))}
        </select>
      </div>

      {/* Control Panel - Right side */}
      <div className="absolute right-6 top-1/2 -translate-y-1/2 z-20 space-y-6">
        {/* Animation Mode Toggle */}
        <div className="bg-black/80 backdrop-blur-sm border-2 border-yellow-500/50 rounded-lg p-4 min-w-[240px]">
          <label className="block text-yellow-400 font-orbitron text-xs uppercase tracking-wider mb-3">
            Animation Mode
          </label>
          <div className="flex gap-2">
            <button
              onClick={() => setAnimationMode('forward')}
              className={`flex-1 px-3 py-2 text-xs font-orbitron uppercase tracking-wider rounded transition-all ${
                animationMode === 'forward'
                  ? 'bg-yellow-500/30 border-2 border-yellow-400 text-yellow-300'
                  : 'bg-black/50 border border-yellow-500/30 text-yellow-500/70 hover:bg-yellow-500/10 hover:border-yellow-400/50'
              }`}
            >
              Forward
            </button>
            <button
              onClick={() => setAnimationMode('glide')}
              className={`flex-1 px-3 py-2 text-xs font-orbitron uppercase tracking-wider rounded transition-all ${
                animationMode === 'glide'
                  ? 'bg-yellow-500/30 border-2 border-yellow-400 text-yellow-300'
                  : 'bg-black/50 border border-yellow-500/30 text-yellow-500/70 hover:bg-yellow-500/10 hover:border-yellow-400/50'
              }`}
            >
              Glide
            </button>
          </div>
          <div className="text-yellow-500/70 text-xs mt-2 text-center font-mono">
            {animationMode === 'forward' ? 'Forward Motion' : 'Asteroid Belt Glide'}
          </div>
        </div>

        {/* Star Scale Slider */}
        <div className="bg-black/80 backdrop-blur-sm border-2 border-yellow-500/50 rounded-lg p-4 min-w-[240px]">
          <label className="block text-yellow-400 font-orbitron text-xs uppercase tracking-wider mb-2">
            Star Scale
          </label>
          <input
            type="range"
            min="0.3"
            max="3"
            step="0.1"
            value={starScale}
            onChange={(e) => setStarScale(parseFloat(e.target.value))}
            className="w-full debug-slider"
          />
          <div className="text-yellow-500/70 text-xs mt-1 text-center font-mono">
            {starScale.toFixed(1)}x
          </div>
        </div>

        {/* Star Speed Slider */}
        <div className="bg-black/80 backdrop-blur-sm border-2 border-yellow-500/50 rounded-lg p-4 min-w-[240px]">
          <label className="block text-yellow-400 font-orbitron text-xs uppercase tracking-wider mb-2">
            Star Speed
          </label>
          <input
            type="range"
            min="0.5"
            max="30"
            step="0.5"
            value={starSpeed}
            onChange={(e) => setStarSpeed(parseFloat(e.target.value))}
            className="w-full debug-slider"
          />
          <div className="text-yellow-500/70 text-xs mt-1 text-center font-mono">
            {starSpeed.toFixed(1)}x
          </div>
        </div>

        {/* Star Frequency Slider */}
        <div className="bg-black/80 backdrop-blur-sm border-2 border-yellow-500/50 rounded-lg p-4 min-w-[240px]">
          <label className="block text-yellow-400 font-orbitron text-xs uppercase tracking-wider mb-2">
            Star Density
          </label>
          <input
            type="range"
            min="50"
            max="500"
            step="10"
            value={starFrequency}
            onChange={(e) => setStarFrequency(parseInt(e.target.value))}
            className="w-full debug-slider"
          />
          <div className="text-yellow-500/70 text-xs mt-1 text-center font-mono">
            {starFrequency} stars
          </div>
        </div>

        {/* Logo Size Slider */}
        <div className="bg-black/80 backdrop-blur-sm border-2 border-yellow-500/50 rounded-lg p-4 min-w-[240px]">
          <label className="block text-yellow-400 font-orbitron text-xs uppercase tracking-wider mb-2">
            Logo Size
          </label>
          <input
            type="range"
            min="200"
            max="1000"
            step="10"
            value={logoSize}
            onChange={(e) => setLogoSize(parseInt(e.target.value))}
            className="w-full debug-slider"
          />
          <div className="text-yellow-500/70 text-xs mt-1 text-center font-mono">
            {logoSize}px
          </div>
        </div>

        {/* Motion Blur Toggle */}
        <div className="bg-black/80 backdrop-blur-sm border-2 border-yellow-500/50 rounded-lg p-4 min-w-[240px]">
          <label className="block text-yellow-400 font-orbitron text-xs uppercase tracking-wider mb-3">
            Motion Blur
          </label>
          <button
            onClick={() => setMotionBlurEnabled(!motionBlurEnabled)}
            className={`w-full px-3 py-2 text-xs font-orbitron uppercase tracking-wider rounded transition-all ${
              motionBlurEnabled
                ? 'bg-yellow-500/30 border-2 border-yellow-400 text-yellow-300'
                : 'bg-black/50 border border-yellow-500/30 text-yellow-500/70 hover:bg-yellow-500/10 hover:border-yellow-400/50'
            }`}
          >
            {motionBlurEnabled ? 'Enabled' : 'Disabled'}
          </button>
        </div>

        {/* Motion Blur Intensity Slider */}
        {motionBlurEnabled && (
          <div className="bg-black/80 backdrop-blur-sm border-2 border-yellow-500/50 rounded-lg p-4 min-w-[240px]">
            <label className="block text-yellow-400 font-orbitron text-xs uppercase tracking-wider mb-2">
              Blur Intensity
            </label>
            <input
              type="range"
              min="0"
              max="1"
              step="0.05"
              value={motionBlurIntensity}
              onChange={(e) => setMotionBlurIntensity(parseFloat(e.target.value))}
              className="w-full debug-slider"
            />
            <div className="text-yellow-500/70 text-xs mt-1 text-center font-mono">
              {(motionBlurIntensity * 100).toFixed(0)}%
            </div>
          </div>
        )}
      </div>

      {/* Logo - centered */}
      <div className="absolute inset-0 flex items-center justify-center z-10 px-4">
        <div className="flex flex-col items-center gap-4 sm:gap-6 md:gap-8 w-full max-w-7xl">
          <div className="relative max-w-[80vw] max-h-[80vw]" style={{ width: `${logoSize}px`, height: `${logoSize}px` }}>
            <Image
              src="/logo/multi-color-big-3.webp"
              alt="Mek Tycoon"
              fill
              className="object-contain"
              priority
            />
          </div>

          {/* Description - Mobile Optimized */}
          <div className="w-full max-w-xs sm:max-w-md md:max-w-xl lg:max-w-2xl px-4 sm:px-6 text-center">
            <p className="text-yellow-400/90
                          text-sm sm:text-base md:text-lg lg:text-xl
                          tracking-wide leading-relaxed
                          break-words"
               style={{ fontFamily: selectedFont }}>
              A futuristic idle tycoon game featuring collectible Mek NFTs. Build your empire through resource management, strategic crafting, and automated gold generation.
            </p>
          </div>

          {/* Phase Carousel */}
          <div className="w-full mt-8 sm:mt-12">
            <PhaseCarousel />
          </div>
        </div>
      </div>
    </div>
  );
}
